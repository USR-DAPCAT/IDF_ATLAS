---
author: "Rai Puig & Jordi Real"
website: "https://github.com/USR-DAPCAT/"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  word_document: default
  pdf_document: default
params:
  dir_dades: "dades" 

title: "Prevalencia de la  diabetes mellitus en Catalunya 2010-2018 \n Year: `r params$year`"
---

&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logos_css/logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>


<div class="watermark">DRAFT</div>

****



# Objetivo


&check; Estimacion de frecuencia, y prevalencia de Diabetes Mellitus por grupo de edad , sexo y ruralidad <br/>



# Resultados

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=F,size="huge")


###########

library("dplyr")
library("lubridate")
library("purrr")


# Funcions 
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

conductor<-here::here("conductor_PrevDH.xlsx")

# directori_dades<-params$dir_dades
directori_dades<-params$dir_dades

```


```{r lectura, include = FALSE, echo=FALSE}
dades<- readRDS(here::here(directori_dades,"dt_PREVAL.Rds"))
```


```{r preparacio, echo=F}

dades<-dades %>% mutate(year=stringr::str_sub(dtindex,1,4))

dades <- dades %>% mutate(edat=as.numeric((ymd(dtindex)-ymd(dnaix))/365.25))
#-----------------------------------------------------------------------------------------#
dades<-dades %>% mutate_at(vars( starts_with("DG.") ), funs( if_else(.==0  | is.na(.)  ,0,1)))
#-----------------------------------------------------------------------------------------#



dades<-dades%>%mutate(edat.cat2=case_when(     edat<20~"<20",
                                                    edat>=20 & edat<25 ~ "[20-25)",  
                                                    edat>=25 & edat<30 ~ "[25-30)",  
                                                    edat>=30 & edat<35 ~ "[30-35)",  
                                                    edat>=35 & edat<40 ~ "[35-40)",  
                                                    edat>=40 & edat<45 ~ "[40-45)",  
                                                    edat>=45 & edat<50 ~ "[45-50)",  
                                                    edat>=50 & edat<55 ~ "[50-55)",  
                                                    edat>=55 & edat<60 ~ "[55-60)",  
                                                    edat>=60 & edat<65 ~ "[60-65)",  
                                                    edat>=65 & edat<70 ~ "[65-70)",  
                                                    edat>=70 & edat<75 ~ "[70-75)",  
                                                    edat>=75 & edat<80 ~ "[75-80)",  
                                                    edat>=80 & edat<85 ~ "[80-85)",  
                                                    edat>=85 & edat<90 ~ "[85-90)",  
                                                    edat>=90~ ">=90" ),
                      edat=round(edat,1))


dades<-dades %>% mutate(ruralitat=if_else(ruralitat=="","ND",ruralitat))

dades<-dades %>% etiquetar_valors(variables_factors = conductor,fulla = "etiquetes")



```

```{r save}

dt_colapsat<-
   dades %>% group_by(year,edat.cat2,sexe,ruralitat) %>% 
   summarise(N=n(), DG.DM=sum(DG.DM), DG.DM2=sum(DG.DM2),DG.DMG=sum(DG.DMG)) %>% 
   ungroup()

saveRDS(dt_colapsat,here::here(params$dir_dades,"fitxer_colapsat.Rds"))
saveRDS(dades,here::here(params$dir_dades,"dades.Rds"))

# 
# dt_colapsat<-readRDS("fitxer_colapsat.Rds")

```


